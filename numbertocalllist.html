<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Number To Call List</title>
  <style>
    :root {
      --primary-color: #4a6bff;
      --secondary-color: #f5f7ff;
      --text-color: #333;
      --white: #fff;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --notification-color: #ff6b6b;
      --dark-bg: #1a1a1a;
      --dark-text: #f0f0f0;
      --dark-secondary: #2d2d2d;
      --dark-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --success-color: #4CAF50;
      --warning-color: #FFC107;
      --danger-color: #dc3545;
      --info-bg: #fff5f5;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--secondary-color);
      color: var(--text-color);
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s;
      padding-top: 50px;
      padding-bottom: 70px;
    }

    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }

    /* Header Styles */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      background-color: var(--white);
      box-shadow: var(--shadow);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      transition: background-color 0.3s, box-shadow 0.3s;
      border-bottom-left-radius: 30px;
      border-bottom-right-radius: 30px;
      height: 50px;
    }
    
    body.dark-mode header {
      background-color: var(--dark-secondary);
      box-shadow: var(--dark-shadow);
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 50%;
      overflow: hidden;
    }
    
    .logo {
      height: 30px;
      width: auto;
      max-width: 100%;
      object-fit: contain;
    }
    
    .app-title {
      font-weight: 700;
      font-size: 16px;
      color: var(--primary-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .balance-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .balance {
      background-color: var(--primary-color);
      color: var(--white);
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 12px;
      white-space: nowrap;
      display: flex;
      flex-direction: row-reverse;
      gap: 5px;
      transition: transform 0.3s;
    }
    
    .balance.update {
      transform: scale(1.1);
    }
    
    .icon-btn {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 18px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s;
      padding: 5px;
      width: 15px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    body.dark-mode .icon-btn {
      color: var(--dark-text);
    }
    
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--notification-color);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .notification-badge.pulse {
      animation: pulse 0.5s 2;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    
    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .theme-toggle .fa-sun,
    .theme-toggle .fa-moon {
      transition: opacity 0.3s;
    }
    
    body.dark-mode .theme-toggle .fa-sun {
      display: block;
      opacity: 1;
    }
    
    body.dark-mode .theme-toggle .fa-moon {
      display: none;
      opacity: 0;
    }
    
    body:not(.dark-mode) .theme-toggle .fa-sun {
      display: none;
      opacity: 0;
    }
    
    body:not(.dark-mode) .theme-toggle .fa-moon {
      display: block;
      opacity: 1;
    }

    /* Navigation Bar Styles */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: var(--white);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 100;
      transition: background-color 0.3s, box-shadow 0.3s;
      border-top-left-radius: 30px;
      border-top-right-radius: 30px;
      height: 60px;
    }
    
    body.dark-mode .bottom-nav {
      background-color: var(--dark-secondary);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
    }
    
    .nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: var(--text-color);
      font-size: 12px;
      transition: all 0.3s;
      padding: 8px 12px;
      position: relative;
      flex: 1;
      max-width: 33.33%;
    }
    
    body.dark-mode .nav-btn {
      color: var(--dark-text);
    }
    
    .nav-btn i {
      font-size: 20px;
      margin-bottom: 4px;
      transition: color 0.3s;
    }
    
    .nav-btn:hover i {
      color: var(--primary-color);
    }
    
    .nav-btn.active i {
      color: var(--primary-color);
    }
    
    .nav-btn.active::after {
      content: '';
      position: absolute;
      bottom: -8px;
      width: 6px;
      height: 6px;
      background-color: var(--primary-color);
      border-radius: 50%;
    }

    /* Main Content */
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      width: 100%;
      flex: 1;
    }

    .service-card {
      background-color: var(--white);
      border-radius: 10px;
      padding: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    body.dark-mode .service-card {
      background-color: var(--dark-secondary);
      box-shadow: var(--dark-shadow);
    }

    .service-title {
      text-align: center;
      margin-bottom: 20px;
      font-size: 22px;
      color: var(--primary-color);
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
    }

    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode select {
      background-color: #333;
      color: var(--dark-text);
      border-color: #444;
    }

    /* Animated Price Input */
    .price-input-container {
      position: relative;
    }

    .price-input {
      background-color: #f5f5f5;
      color: #666;
      position: relative;
      z-index: 1;
      border: 2px solid var(--success-color) !important;
    }

    body.dark-mode .price-input {
      background-color: #333;
      color: #aaa;
    }

    .delivery-time {
      text-align: center;
      margin: 10px 0;
      font-weight: 600;
      color: var(--success-color);
    }

    .info-box {
      background-color: var(--info-bg);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin: 15px 0;
      color: #d32f2f;
      font-weight: 500;
    }

    body.dark-mode .info-box {
      background-color: #3a1c1c;
    }

    .order-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .order-btn i {
      font-size: 18px;
    }

    .order-btn:hover {
      background-color: #3a5bd9;
      transform: translateY(-2px);
    }

    /* Success Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal-overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background-color: var(--white);
      padding: 25px;
      border-radius: 10px;
      max-width: 90%;
      width: 400px;
      text-align: center;
      transform: translateY(20px);
      transition: transform 0.3s;
    }

    body.dark-mode .modal-content {
      background-color: var(--dark-secondary);
    }

    .modal-overlay.show .modal-content {
      transform: translateY(0);
    }

    .modal-icon {
      font-size: 50px;
      color: var(--success-color);
      margin-bottom: 15px;
    }

    .modal-title {
      font-size: 22px;
      margin-bottom: 10px;
      color: var(--primary-color);
    }

    .modal-text {
      margin-bottom: 20px;
    }

    .modal-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--success-color);
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      box-shadow: var(--shadow);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
      max-width: 90%;
      text-align: center;
      display: none;
    }

    .toast.show {
      opacity: 1;
      display: block;
    }

    .toast.error {
      background-color: var(--danger-color);
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .loading-overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Admin Price Controls */
    .admin-controls {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }

    body.dark-mode .admin-controls {
      background-color: #2d2d2d;
    }

    .admin-title {
      font-size: 18px;
      margin-bottom: 10px;
      color: var(--primary-color);
    }

    .price-controls {
      display: flex;
      gap: 10px;
    }

    .price-controls input {
      flex: 1;
    }

    .save-price-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }

    @media (min-width: 768px) {
      .logo {
        height: 35px;
      }
      
      .app-title {
        font-size: 18px;
      }
      
      .balance {
        font-size: 14px;
        padding: 6px 12px;
      }
      
      .icon-btn {
        font-size: 20px;
      }
    }
    
    @media (max-width: 480px) {
      .app-title {
        font-size: 14px;
      }
      
      .logo {
        height: 25px;
      }
      
      .header-controls {
        gap: 10px;
      }
      
      .balance {
        font-size: 11px;
        padding: 4px 8px;
      }
      
      .icon-btn {
        font-size: 16px;
      }
      
      .notification-badge {
        width: 16px;
        height: 16px;
        font-size: 9px;
      }
    }
  </style>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo-container">
      <a href="index.html">
        <img src="https://blogger.googleusercontent.com/img/a/AVvXsEgtMmwDkd4fcMuYiu4PceeC3kh63S5tv-Wnm1qRDGRLYplLsXgwz37EYr_QTqJRdNHBPkuC9bPzi6eSRPU9c7Q8w32nC_wUmwcOAn65iKHOy-Xw5Z04vbMsLuIYHM7D0sOZlEy4vMWQ8ULGch8AqvU7sE7W66t_cyFFAjMHxdxvA7GzHNL6ENkTQEJt=s1600" alt="App Logo" class="logo" id="header-logo">
      </a>
      <div class="app-title" id="header-title"></div>
    </div>
    
    <div class="header-controls">
      <div class="balance-container">
        <span class="balance"><span id="user-balance">0.00</span>৳</span>
      </div>
      <button class="icon-btn theme-toggle" id="theme-toggle">
        <i class="fas fa-sun"></i>
        <i class="fas fa-moon"></i>
      </button>
      <button class="icon-btn" id="orders-btn" onclick="window.location.href='orders.html'">
        <i class="fas fa-clipboard-list"></i>
      </button>
      <button class="icon-btn" id="notification-btn" onclick="window.location.href='notifications.html'">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notification-badge">0</span>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <div class="service-card">
      <h2 class="service-title">Number To Call List Service</h2>

      <form id="order-form">
        <div class="form-group">
          <label for="sim-select">Select SIM</label>
          <select id="sim-select" required>
            <option value="">Select Your SIM</option>
            <option value="BL">Banglalink</option>
            <option value="GP">Grameenphone</option>
            <option value="ROBI">Robi</option>
            <option value="AIRTEL">Airtel</option>
            <option value="TELETALK">Teletalk</option>
          </select>
        </div>

        <div class="form-group">
          <label for="phone-number">Phone Number</label>
          <input
            type="text"
            id="phone-number"
            placeholder="Enter phone number"
            required
          />
        </div>

        <div class="form-group">
          <label for="email">Email Address</label>
          <input
            type="email"
            id="email"
            placeholder="Enter your email address"
            required
          />
        </div>

        <div class="form-group price-input-container">
          <label for="price">Amount</label>
          <input
            type="text"
            id="price"
            class="price-input"
            value="Loading..."
            readonly
          />
        </div>

        <div class="delivery-time" id="delivery-time">লোড হচ্ছে...</div>

        <div class="info-box">লোড হচ্ছে...</div>

        <button type="submit" class="order-btn">
          <i class="fas fa-shopping-cart"></i>
          Order Now
        </button>
      </form>

      <!-- Admin Price Controls (Visible only to admin) -->
      <div class="admin-controls" id="admin-controls">
        <h3 class="admin-title">Admin Price Settings</h3>
        <div class="price-controls">
          <input type="number" id="new-price" placeholder="Enter new price" step="0.01" min="0">
          <button class="save-price-btn" id="save-price-btn">Save Price</button>
        </div>
        <div class="price-controls" style="margin-top: 10px;">
          <input type="text" id="delivery-time-input" placeholder="Enter delivery time text">
          <button class="save-price-btn" id="save-delivery-btn">Save Delivery Time</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="payment.html" class="nav-btn" id="deposit-btn">
      <i class="fas fa-money-bill-wave"></i>
      <span>Deposit</span>
    </a>
    <a href="index.html" class="nav-btn" id="home-btn">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </a>
    <a href="profile.html" class="nav-btn" id="profile-btn">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
  </nav>

  <!-- Success Modal -->
  <div class="modal-overlay" id="success-modal">
    <div class="modal-content">
      <div class="modal-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3 class="modal-title">Order Successful!</h3>
      <p class="modal-text">Your order has been placed successfully.</p>
      <button class="modal-btn" onclick="window.location.href='orders.html'">
        View Orders
      </button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCEn86IfdTNcvEmQuNP-KCvrmMABagcdkc",
      authDomain: "web-iatz.firebaseapp.com",
      projectId: "web-iatz",
      storageBucket: "web-iatz.appspot.com",
      messagingSenderId: "264921056318",
      appId: "1:264921056318:web:c77e93fad660665bdfbd6f",
      databaseURL: "https://web-iatz-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const firestore = firebase.firestore();
    const database = firebase.database();

    // DOM elements
    const orderForm = document.getElementById("order-form");
    const toast = document.getElementById("toast");
    const loadingOverlay = document.getElementById("loading-overlay");
    const successModal = document.getElementById("success-modal");
    const userBalance = document.getElementById("user-balance");
    const themeToggle = document.getElementById("theme-toggle");
    const body = document.body;
    const navBtns = document.querySelectorAll(".nav-btn");
    const notificationBadge = document.getElementById("notification-badge");
    const headerLogo = document.getElementById("header-logo");
    const headerTitle = document.getElementById("header-title");
    const adminControls = document.getElementById("admin-controls");
    const savePriceBtn = document.getElementById("save-price-btn");
    const newPriceInput = document.getElementById("new-price");
    const priceDisplay = document.getElementById("price");
    const deliveryTimeDisplay = document.getElementById("delivery-time");
    const saveDeliveryBtn = document.getElementById("save-delivery-btn");
    const deliveryTimeInput = document.getElementById("delivery-time-input");

    let currentUser = null;
    let servicePrice = 0;
    let unreadNotifications = 0;
    let isAdmin = false;

    // Initialize the app
    function init() {
      showLoading();
      updateHeader();
      setupThemeToggle();
      setupNavigation();
      checkAuthState();
      setupFormSubmit();
      loadServicePrice();
      setupAdminControls();
      hideLoading();
    }

    // Update header with app branding
    function updateHeader() {
      headerLogo.src = "https://blogger.googleusercontent.com/img/a/AVvXsEgtMmwDkd4fcMuYiu4PceeC3kh63S5tv-Wnm1qRDGRLYplLsXgwz37EYr_QTqJRdNHBPkuC9bPzi6eSRPU9c7Q8w32nC_wUmwcOAn65iKHOy-Xw5Z04vbMsLuIYHM7D0sOZlEy4vMWQ8ULGch8AqvU7sE7W66t_cyFFAjMHxdxvA7GzHNL6ENkTQEJt=s1600";
      headerLogo.style.display = "block";
    }

    // Setup theme toggle functionality
    function setupThemeToggle() {
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        body.classList.add("dark-mode");
      }
      
      themeToggle.addEventListener("click", () => {
        body.classList.toggle("dark-mode");
        const isDark = body.classList.contains("dark-mode");
        localStorage.setItem("theme", isDark ? "dark" : "light");
      });
    }

    // Setup navigation buttons
    function setupNavigation() {
      const currentPage = window.location.pathname.split("/").pop() || "index.html";
      navBtns.forEach(btn => {
        const btnPage = btn.getAttribute("href").split("/").pop();
        if (btnPage === currentPage) {
          btn.classList.add("active");
        }
        
        // Add click handler for navigation
        btn.addEventListener("click", (e) => {
          if (!currentUser) {
            e.preventDefault();
            showToast("Please login first", false);
            setTimeout(() => {
              window.location.href = "signin.html";
            }, 1500);
          }
        });
      });
    }

    // Setup admin price controls
    function setupAdminControls() {
      savePriceBtn.addEventListener("click", async () => {
        const newPrice = parseFloat(newPriceInput.value);
        if (isNaN(newPrice) || newPrice <= 0) {
          showToast("Please enter a valid price", false);
          return;
        }

        try {
          showLoading();
          await saveServicePrice(newPrice);
          showToast("Price updated successfully", true);
          newPriceInput.value = "";
        } catch (error) {
          console.error("Error updating price:", error);
          showToast("Failed to update price", false);
        } finally {
          hideLoading();
        }
      });

      saveDeliveryBtn.addEventListener("click", async () => {
        const deliveryText = deliveryTimeInput.value.trim();
        if (!deliveryText) {
          showToast("Please enter delivery time text", false);
          return;
        }

        try {
          showLoading();
          await saveDeliveryTime(deliveryText);
          showToast("Delivery time updated successfully", true);
          deliveryTimeInput.value = "";
        } catch (error) {
          console.error("Error updating delivery time:", error);
          showToast("Failed to update delivery time", false);
        } finally {
          hideLoading();
        }
      });
    }

    // Load service price from Firestore
    function loadServicePrice() {
      firestore
        .collection("price")
        .doc("numberToCallList")
        .get()
        .then((doc) => {
          if (doc.exists) {
            const priceData = doc.data();
            servicePrice = priceData.price;
            const description = priceData.description || "এখনই অর্ডার করুন, সময় সীমিত";
            const deliveryTime = priceData.deliveryTime || "লোড হচ্ছে...";
            
            updatePriceDisplay(servicePrice);
            updateDescription(description);
            updateDeliveryTime(deliveryTime);
          } else {
            // Create initial price document if it doesn't exist
            const defaultPrice = 50.00;
            const defaultDescription = "এখনই অর্ডার করুন, সময় সীমিত";
            const defaultDeliveryTime = "লোড হচ্ছে...";
            saveServicePrice(defaultPrice, defaultDescription, defaultDeliveryTime);
          }
        })
        .catch((error) => {
          console.error("Error loading price:", error);
        });
    }

    // Save service price to Firestore
    async function saveServicePrice(price, description = "", deliveryTime = "") {
      try {
        await firestore
          .collection("price")
          .doc("numberToCallList")
          .set({
            price: price,
            description: description || "এখনই অর্ডার করুন, সময় সীমিত",
            deliveryTime: deliveryTime || "লোড হচ্ছে...",
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser?.uid || "system"
          }, { merge: true });

        servicePrice = price;
        updatePriceDisplay(price);
        
        if (description) {
          updateDescription(description);
        }
        
        if (deliveryTime) {
          updateDeliveryTime(deliveryTime);
        }
      } catch (error) {
        console.error("Error saving price:", error);
        throw error;
      }
    }

    // Save delivery time text
    async function saveDeliveryTime(deliveryTime) {
      try {
        await firestore
          .collection("price")
          .doc("numberToCallList")
          .set({
            deliveryTime: deliveryTime,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser?.uid || "system"
          }, { merge: true });

        updateDeliveryTime(deliveryTime);
      } catch (error) {
        console.error("Error saving delivery time:", error);
        throw error;
      }
    }

    // Update price display
    function updatePriceDisplay(price) {
      const formattedPrice = price.toFixed(2) + "৳";
      priceDisplay.value = formattedPrice;
    }

    // Update delivery time display
    function updateDeliveryTime(text) {
      deliveryTimeDisplay.textContent = text;
    }

    // Update description text
    function updateDescription(text) {
      const infoBox = document.querySelector(".info-box");
      if (infoBox) {
        infoBox.textContent = text;
      }
    }

    // Check user authentication and admin status
    function checkAuthState() {
      auth.onAuthStateChanged(async (user) => {
        currentUser = user;
        if (user) {
          // User is signed in
          await checkAdminStatus(user.uid);
          loadUserData(user.uid);
          setupNotificationListener(user.uid);
          
          // Show/hide admin controls based on admin status
          adminControls.style.display = isAdmin ? "block" : "none";
        } else {
          // No user is signed in - redirect to login
          showToast("Please login to place order", false);
          setTimeout(() => {
            window.location.href = "signin.html";
          }, 1500);
        }
      });
    }

    // Check if user is admin
    async function checkAdminStatus(userId) {
      try {
        const userDoc = await firestore.collection("users").doc(userId).get();
        if (userDoc.exists) {
          isAdmin = userDoc.data().isAdmin || false;
        }
      } catch (error) {
        console.error("Error checking admin status:", error);
        isAdmin = false;
      }
    }

    // Load user data from Firestore
    function loadUserData(userId) {
      const userRef = firestore.collection("users").doc(userId);
      
      userRef.onSnapshot((doc) => {
        if (doc.exists) {
          const userData = doc.data();
          if (userData.balance !== undefined) {
            updateBalanceDisplay(userData.balance);
          }
        }
      }, (error) => {
        console.error("Error loading user data:", error);
        showToast("Error loading user data", false);
      });
    }

    // Setup real-time notification listener
    function setupNotificationListener(userId) {
      const notificationsRef = firestore.collection("notifications")
        .where("userId", "==", userId)
        .where("read", "==", false);
        
      notificationsRef.onSnapshot((snapshot) => {
        unreadNotifications = snapshot.size;
        updateNotificationBadge(unreadNotifications);
      }, (error) => {
        console.error("Notification listener error:", error);
      });
    }

    // Update notification badge
    function updateNotificationBadge(count) {
      const num = parseInt(count) || 0;
      
      if (num > 0) {
        notificationBadge.textContent = num;
        notificationBadge.style.display = "flex";
        
        if (num > parseInt(notificationBadge.dataset.prevCount || 0)) {
          notificationBadge.classList.add("pulse");
          setTimeout(() => {
            notificationBadge.classList.remove("pulse");
          }, 1000);
        }
      } else {
        notificationBadge.style.display = "none";
      }
      
      notificationBadge.dataset.prevCount = num;
    }

    // Update balance display with animation
    function updateBalanceDisplay(balance) {
      const formattedBalance = parseFloat(balance).toFixed(2);
      userBalance.textContent = formattedBalance;
      
      // Add animation
      userBalance.parentElement.classList.add("update");
      setTimeout(() => {
        userBalance.parentElement.classList.remove("update");
      }, 300);
    }

    // Setup form submission
    function setupFormSubmit() {
      orderForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!currentUser) {
          showToast("Please login first", false);
          return;
        }

        const simType = document.getElementById("sim-select").value;
        const phoneNumber = document.getElementById("phone-number").value.trim();
        const email = document.getElementById("email").value.trim();

        if (!simType) {
          showToast("Please select a SIM", false);
          return;
        }

        if (!phoneNumber) {
          showToast("Please enter phone number", false);
          return;
        }

        // Basic phone number validation
        if (!/^(?:\+88|01)?(?:\d{9}|\d{10})$/.test(phoneNumber)) {
          showToast("Please enter a valid Bangladeshi phone number", false);
          return;
        }

        if (!email) {
          showToast("Please enter email address", false);
          return;
        }

        // Basic email validation
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          showToast("Please enter a valid email address", false);
          return;
        }

        try {
          showLoading();

          // First check user balance
          const userDoc = await firestore
            .collection("users")
            .doc(currentUser.uid)
            .get();
          const userData = userDoc.data();
          const currentBalance = userData.balance || 0;

          if (currentBalance < servicePrice) {
            hideLoading();
            showToast("Insufficient balance", false);
            return;
          }

          // Deduct balance
          const newBalance = currentBalance - servicePrice;
          await firestore.collection("users").doc(currentUser.uid).update({
            balance: newBalance,
          });

          // Create order in Firestore
          const orderData = {
            service: "Number To Call List",
            simType,
            phoneNumber,
            email,
            amount: servicePrice,
            status: "pending",
            userId: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          };

          await firestore.collection("orders").add(orderData);

          // Show success modal
          hideLoading();
          successModal.classList.add("show");
        } catch (error) {
          console.error("Error placing order:", error);
          hideLoading();
          showToast("Failed to place order", false);
        }
      });
    }

    // Show toast notification
    function showToast(message, isSuccess = true) {
      toast.textContent = message;
      toast.className = isSuccess ? "toast show" : "toast error show";
      
      setTimeout(() => {
        toast.className = "toast";
      }, 3000);
    }

    // Show loading overlay
    function showLoading() {
      loadingOverlay.classList.add("show");
    }

    // Hide loading overlay
    function hideLoading() {
      loadingOverlay.classList.remove("show");
    }

    // Initialize the app when DOM is loaded
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>